!function(t){"object"==typeof exports&&"object"==typeof module?t(require("../../lib/codemirror"),require("../htmlmixed/htmlmixed")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","../htmlmixed/htmlmixed"],t):t(CodeMirror)}(function(v){"use strict";var t={noEndTag:!0,soyState:"param-def"},w={alias:{noEndTag:!0},delpackage:{noEndTag:!0},namespace:{noEndTag:!0,soyState:"namespace-def"},"@attribute":t,"@attribute?":t,"@param":t,"@param?":t,"@inject":t,"@inject?":t,"@state":t,template:{soyState:"templ-def",variableScope:!0},extern:{soyState:"param-def"},export:{soyState:"export"},literal:{},msg:{},fallbackmsg:{noEndTag:!0,reduceIndent:!0},select:{},plural:{},let:{soyState:"var-def"},if:{},javaimpl:{},jsimpl:{},elseif:{noEndTag:!0,reduceIndent:!0},else:{noEndTag:!0,reduceIndent:!0},switch:{},case:{noEndTag:!0,reduceIndent:!0},default:{noEndTag:!0,reduceIndent:!0},foreach:{variableScope:!0,soyState:"for-loop"},ifempty:{noEndTag:!0,reduceIndent:!0},for:{variableScope:!0,soyState:"for-loop"},call:{soyState:"templ-ref"},param:{soyState:"param-ref"},print:{noEndTag:!0},deltemplate:{soyState:"templ-def",variableScope:!0},delcall:{soyState:"templ-ref"},log:{},element:{variableScope:!0},velog:{},const:{soyState:"const-def"}},k=Object.keys(w).filter(function(t){return!w[t].noEndTag||w[t].reduceIndent});v.defineMode("soy",function(m){var t=v.getMode(m,"text/plain"),d={html:v.getMode(m,{name:"text/html",multilineTagIndentFactor:2,multilineTagIndentPastTag:!1,allowMissingTagName:!0}),attributes:t,text:t,uri:t,trusted_resource_uri:t,css:v.getMode(m,"text/css"),js:v.getMode(m,{name:"text/javascript",statementIndent:2*m.indentUnit})};function y(t){return t[t.length-1]}function h(e,a,t){if(e.sol()){for(var n=0;n<a.indent&&e.eat(/\s/);n++);if(n)return null}var o=e.string,t=t.exec(o.substr(e.pos)),t=(t&&(e.string=o.substr(0,e.pos+t.index)),e.hideFirstChars(a.indent,function(){var t=y(a.localStates);return t.mode.token(e,t.state)}));return e.string=o,t}function S(t,e){return{element:e,next:t}}function f(t){t.context&&(t.context.scope&&(t.variables=t.context.scope),t.context=t.context.previousContext)}function x(t,e,a){return function(t,e){for(;t;){if(t.element===e)return 1;t=t.next}}(t,e)?"variable-2":a?"variable":"variable-2 error"}function g(t,e,a){this.previousContext=t,this.tag=e,this.kind=null,this.scope=a}function b(t,e){var a;return t.match(/[[]/)?(e.soyState.push("list-literal"),e.context=new g(e.context,"list-literal",e.variables),e.lookupVariables=!1,null):t.match(/\bmap(?=\()/)?(e.soyState.push("map-literal"),"keyword"):t.match(/\brecord(?=\()/)?(e.soyState.push("record-literal"),"keyword"):t.match(/([\w]+)(?=\()/)?"variable callee":(a=t.match(/^["']/))?(e.soyState.push("string"),e.quoteKind=a[0],"string"):t.match(/^[(]/)?(e.soyState.push("open-parentheses"),null):t.match(/(null|true|false)(?!\w)/)||t.match(/0x([0-9a-fA-F]{2,})/)||t.match(/-?([0-9]*[.])?[0-9]+(e[0-9]*)?/)?"atom":t.match(/(\||[+\-*\/%]|[=!]=|\?:|[<>]=?)/)?"operator":(a=t.match(/^\$([\w]+)/))?x(e.variables,a[1],!e.lookupVariables):(a=t.match(/^\w+/))?/^(?:as|and|or|not|in|if)$/.test(a[0])?"keyword":null:(t.next(),null)}return{startState:function(){return{soyState:[],variables:S(null,"ij"),scopes:null,indent:0,quoteKind:null,context:null,lookupVariables:!0,localStates:[{mode:d.html,state:v.startState(d.html)}]}},copyState:function(t){return{tag:t.tag,soyState:t.soyState.concat([]),variables:t.variables,context:t.context,indent:t.indent,quoteKind:t.quoteKind,lookupVariables:t.lookupVariables,localStates:t.localStates.map(function(t){return{mode:t.mode,state:v.copyState(t.mode,t.state)}})}},token:function(t,e){var a,n;switch(y(e.soyState)){case"comment":if(t.match(/^.*?\*\//)?e.soyState.pop():t.skipToEnd(),!e.context||!e.context.scope)for(var o,r=/@param\??\s+(\S+)/g,s=t.current();o=r.exec(s);)e.variables=S(e.variables,o[1]);return"comment";case"string":return(o=t.match(/^.*?(["']|\\[\s\S])/))?o[1]==e.quoteKind&&(e.quoteKind=null,e.soyState.pop()):t.skipToEnd(),"string"}if(!e.soyState.length||"literal"!=y(e.soyState)){if(t.match(/^\/\*/))return e.soyState.push("comment"),"comment";if(t.match(t.sol()?/^\s*\/\/.*/:/^\s+\/\/.*/))return"comment"}switch(y(e.soyState)){case"templ-def":return(o=t.match(/^\.?([\w]+(?!\.[\w]+)*)/))?(e.soyState.pop(),"def"):(t.next(),null);case"templ-ref":return(o=t.match(/(\.?[a-zA-Z_][a-zA-Z_0-9]+)+/))?(e.soyState.pop(),"."==o[0][0]?"variable-2":"variable"):(o=t.match(/^\$([\w]+)/))?(e.soyState.pop(),x(e.variables,o[1],!e.lookupVariables)):(t.next(),null);case"namespace-def":return(o=t.match(/^\.?([\w\.]+)/))?(e.soyState.pop(),"variable"):(t.next(),null);case"param-def":return(o=t.match(/^\*/))?(e.soyState.pop(),e.soyState.push("param-type"),"type"):(o=t.match(/^\w+/))?(e.variables=S(e.variables,o[0]),e.soyState.pop(),e.soyState.push("param-type"),"def"):(t.next(),null);case"param-ref":return(o=t.match(/^\w+/))?(e.soyState.pop(),"property"):(t.next(),null);case"open-parentheses":return t.match(/[)]/)?(e.soyState.pop(),null):b(t,e);case"param-type":var l=t.peek();return-1!="}]=>,".indexOf(l)?(e.soyState.pop(),null):"["==l?(e.soyState.push("param-type-record"),null):"("==l?(e.soyState.push("param-type-template"),null):"<"==l?(e.soyState.push("param-type-parameter"),null):(o=t.match(/^([\w]+|[?])/))?"type":(t.next(),null);case"param-type-record":return"]"==(l=t.peek())?(e.soyState.pop(),null):t.match(/^\w+/)?(e.soyState.push("param-type"),"property"):(t.next(),null);case"param-type-parameter":return t.match(/^[>]/)?(e.soyState.pop(),null):(t.match(/^[<,]/)?e.soyState.push("param-type"):t.next(),null);case"param-type-template":return t.match(/[>]/)?(e.soyState.pop(),e.soyState.push("param-type"),null):t.match(/^\w+/)?(e.soyState.push("param-type"),"def"):(t.next(),null);case"var-def":return(o=t.match(/^\$([\w]+)/))?(e.variables=S(e.variables,o[1]),e.soyState.pop(),"def"):(t.next(),null);case"for-loop":return t.match(/\bin\b/)?(e.soyState.pop(),"keyword"):("$"==t.peek()?e.soyState.push("var-def"):t.next(),null);case"record-literal":return t.match(/^[)]/)?(e.soyState.pop(),null):(t.match(/[(,]/)?(e.soyState.push("map-value"),e.soyState.push("record-key")):t.next(),null);case"map-literal":return t.match(/^[)]/)?(e.soyState.pop(),null):(t.match(/[(,]/)?(e.soyState.push("map-value"),e.soyState.push("map-value")):t.next(),null);case"list-literal":return t.match("]")?(e.soyState.pop(),e.lookupVariables=!0,f(e),null):t.match(/\bfor\b/)?(e.lookupVariables=!0,e.soyState.push("for-loop"),"keyword"):b(t,e);case"record-key":return t.match(/[\w]+/)?"property":(t.match(/^[:]/)?e.soyState.pop():t.next(),null);case"map-value":return")"==t.peek()||","==t.peek()||t.match(/^[:)]/)?(e.soyState.pop(),null):b(t,e);case"import":return t.eat(";")?(e.soyState.pop(),e.indent-=2*m.indentUnit,null):t.match(/\w+(?=\s+as\b)/)?"variable":(o=t.match(/\w+/))?/\b(from|as)\b/.test(o[0])?"keyword":"def":(o=t.match(/^["']/))?(e.soyState.push("string"),e.quoteKind=o[0],"string"):(t.next(),null);case"tag":p=void 0===e.tag?(i=!0,""):(i="/"==e.tag[0])?e.tag.substring(1):e.tag;var i,p,c,u=w[p];return t.match(/^\/?}/)?((l="/}"==t.current())&&!i&&f(e),"/template"==e.tag||"/deltemplate"==e.tag?(e.variables=S(null,"ij"),e.indent=0):e.indent-=m.indentUnit*(l||-1==k.indexOf(e.tag)?2:1),e.soyState.pop(),"keyword"):t.match(/^([\w?]+)(?==)/)?(e.context&&e.context.tag==p&&"kind"==t.current()&&(o=t.match(/^="([^"]+)/,!1))&&(l=o[1],e.context.kind=l,l=d[l]||d.html,(c=y(e.localStates)).mode.indent&&(e.indent+=c.mode.indent(c.state,"","")),e.localStates.push({mode:l,state:v.startState(l)})),"attribute"):b(t,e);case"template-call-expression":return t.match(/^([\w-?]+)(?==)/)?"attribute":t.eat(">")||t.eat("/>")?(e.soyState.pop(),"keyword"):b(t,e);case"literal":return t.match("{/literal}",!1)?(e.soyState.pop(),this.token(t,e)):h(t,e,/\{\/literal}/);case"export":if(o=t.match(/\w+/)){if(e.soyState.pop(),"const"==o)return e.soyState.push("const-def"),"keyword";if("extern"==o)return e.soyState.push("param-def"),"keyword"}else t.next();return null;case"const-def":return t.match(/^\w+/)?(e.soyState.pop(),"def"):(t.next(),null)}return t.match("{literal}")?(e.indent+=m.indentUnit,e.soyState.push("literal"),e.context=new g(e.context,"literal",e.variables),"keyword"):(o=t.match(/^\{([/@\\]?\w+\??)(?=$|[\s}]|\/[/*])/))?(a=e.tag,e.tag=o[1],i="/"==e.tag[0],n=!!w[e.tag],p=i?e.tag.substring(1):e.tag,u=w[p],"/switch"!=e.tag&&(e.indent+=((i||u&&u.reduceIndent)&&"switch"!=a?1:2)*m.indentUnit),e.soyState.push("tag"),a=!1,u?(i||u.soyState&&e.soyState.push(u.soyState),u.noEndTag||!n&&i?i&&(n="extern"==p&&e.context&&"export"==e.context.tag,!e.context||e.context.tag!=p&&!n?a=!0:e.context&&(e.context.kind&&(e.localStates.pop(),(c=y(e.localStates)).mode.indent&&(e.indent-=c.mode.indent(c.state,"",""))),f(e))):e.context=new g(e.context,e.tag,u.variableScope?e.variables:null)):i&&(a=!0),(a?"error ":"")+"keyword"):t.eat("{")?(e.tag="print",e.indent+=2*m.indentUnit,e.soyState.push("tag"),"keyword"):!e.context&&t.sol()&&t.match(/import\b/)?(e.soyState.push("import"),e.indent+=2*m.indentUnit,"keyword"):(o=t.match("<{"))?(e.soyState.push("template-call-expression"),e.indent+=2*m.indentUnit,e.soyState.push("tag"),"keyword"):(o=t.match("</>"))?(e.indent-=+m.indentUnit,"keyword"):h(t,e,/\{|\s+\/\/|\/\*/)},indent:function(t,e,a){var n=t.indent,o=y(t.soyState);if("comment"==o)return v.Pass;if("literal"==o)/^\{\/literal}/.test(e)&&(n-=m.indentUnit);else{if(/^\s*\{\/(template|deltemplate)\b/.test(e))return 0;/^\{(\/|(fallbackmsg|elseif|else|ifempty)\b)/.test(e)&&(n-=m.indentUnit),"switch"!=t.tag&&/^\{(case|default)\b/.test(e)&&(n-=m.indentUnit),/^\{\/switch\b/.test(e)&&(n-=m.indentUnit)}o=y(t.localStates);return n&&o.mode.indent&&(n+=o.mode.indent(o.state,e,a)),n},innerMode:function(t){return t.soyState.length&&"literal"!=y(t.soyState)?null:y(t.localStates)},electricInput:/^\s*\{(\/|\/template|\/deltemplate|\/switch|fallbackmsg|elseif|else|case|default|ifempty|\/literal\})$/,lineComment:"//",blockCommentStart:"/*",blockCommentEnd:"*/",blockCommentContinue:" * ",useInnerComments:!1,fold:"indent"}},"htmlmixed"),v.registerHelper("wordChars","soy",/[\w$]/),v.registerHelper("hintWords","soy",Object.keys(w).concat(["css","debugger"])),v.defineMIME("text/x-soy","soy")});