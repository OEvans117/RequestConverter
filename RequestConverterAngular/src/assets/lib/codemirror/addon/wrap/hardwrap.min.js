!function(t){"object"==typeof exports&&"object"==typeof module?t(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror"],t):t(CodeMirror)}(function(k){"use strict";var S=k.Pos;function l(t,r,e){for(var n=e.paragraphStart||t.getHelper(r,"paragraphStart"),o=r.line,a=t.firstLine();a<o;--o){var i=t.getLine(o);if(n&&n.test(i))break;if(!/\S/.test(i)){++o;break}}for(var f=e.paragraphEnd||t.getHelper(r,"paragraphEnd"),l=r.line+1,h=t.lastLine();l<=h;++l){i=t.getLine(l);if(f&&f.test(i)){++l;break}if(!/\S/.test(i))break}return{from:o,to:l}}function E(t,r,e,n,o){for(var a=r;a<t.length&&" "==t.charAt(a);)a++;for(;0<a&&!e.test(t.slice(a-1,a+1));--a);if(!o&&a<=t.match(/^[ \t]*/)[0].length)for(a=r+1;a<t.length-1&&!e.test(t.slice(a-1,a+1));++a);for(var i=!0;;i=!1){var f=a;if(n)for(;" "==t.charAt(f-1);)--f;if(0!=f||!i)return{from:f,to:a};a=r}}function h(e,t,r,n){t=e.clipPos(t),r=e.clipPos(r);var o=n.column||80,a=n.wrapOn||/\s\S|-[^\.\d]/,i=!1!==n.forceBreak,f=!1!==n.killTrailingSpace,l=[],h="",s=t.line,c=e.getRange(t,r,!1);if(!c.length)return null;var g=c[0].match(/^[ \t]*/)[0];g.length>=o&&(o=g.length+1);for(var p=0;p<c.length;++p){var m,u=c[p],v=h.length,d=0,b=(h&&u&&!a.test(h.charAt(h.length-1)+u.charAt(0))&&(h+=" ",d=1),"");for(p&&(b=u.match(/^\s*/)[0],u=u.slice(b.length)),h+=u,p&&((m=h.length>o&&g==b&&E(h,o,a,f,i))&&m.from==v&&m.to==v+d?(h=g+u,++s):l.push({text:[d?" ":""],from:S(s,v),to:S(s+1,b.length)}));h.length>o;){var x=E(h,o,a,f,i);if(!(x.from!=x.to||i&&g!==h.slice(0,x.to)))break;l.push({text:["",g],from:S(s,x.from),to:S(s,x.to)}),h=g+h.slice(x.to),++s}}return l.length&&e.operation(function(){for(var t=0;t<l.length;++t){var r=l[t];(r.text||k.cmpPos(r.from,r.to))&&e.replaceRange(r.text,r.from,r.to)}}),l.length?{from:l[0].from,to:k.changeEnd(l[l.length-1])}:null}k.defineExtension("wrapParagraph",function(t,r){r=r||{},t=t||this.getCursor();t=l(this,t,r);return h(this,S(t.from,0),S(t.to-1),r)}),k.commands.wrapLines=function(a){a.operation(function(){for(var t=a.listSelections(),r=a.lastLine()+1,e=t.length-1;0<=e;e--){var n,o=t[e];(n=o.empty()?(n=l(a,o.head,{}),{from:S(n.from,0),to:S(n.to-1)}):{from:o.from(),to:o.to()}).to.line>=r||(r=n.from.line,h(a,n.from,n.to,{}))}})},k.defineExtension("wrapRange",function(t,r,e){return h(this,t,r,e||{})}),k.defineExtension("wrapParagraphsInRange",function(t,r,e){e=e||{};for(var n=this,o=[],a=t.line;a<=r.line;){var i=l(n,S(a,0),e);o.push(i),a=i.to}var f=!1;return o.length&&n.operation(function(){for(var t=o.length-1;0<=t;--t)f=f||h(n,S(o[t].from,0),S(o[t].to-1),e)}),f})});