!function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror"],e):e(CodeMirror)}(function(g){"use strict";g.TernServer=function(e){var s=this,e=(this.options=e||{},this.options.plugins||(this.options.plugins={}));e.doc_comment||(e.doc_comment=!0),this.docs=Object.create(null),this.options.useWorker?this.server=new i(this):this.server=new tern.Server({getFile:function(e,t){return a(s,e,t)},async:!0,defs:this.options.defs||[],plugins:e}),this.trackChange=function(e,t){var n=s,o=u(n,e),i=n.cachedArgHints,r=(i&&i.doc==e&&0<=y(i.start,t.to)&&(n.cachedArgHints=null),null==(i=o.changed)&&(o.changed=i={from:t.from.line,to:t.from.line}),t.from.line+(t.text.length-1));t.from.line<i.to&&(i.to=i.to-(t.to.line-r)),r>=i.to&&(i.to=r+1),i.from>t.from.line&&(i.from=t.from.line),e.lineCount()>l&&100<t.to-i.from&&setTimeout(function(){o.changed&&100<o.changed.to-o.changed.from&&c(n,o)},200)},this.cachedArgHints=null,this.activeArgHints=null,this.jumpStack=[],this.getHint=function(e,t){var l,u,f;u=e,f=t,(l=s).request(u,{type:"completions",types:!0,docs:!0,urls:!0},function(e,t){if(e)return b(l,u,e);var n=[],o="",e=t.start,i=t.end;'["'==u.getRange(m(e.line,e.ch-2),e)&&'"]'!=u.getRange(i,m(i.line,i.ch+2))&&(o='"]');for(var r=0;r<t.completions.length;++r){var s=t.completions[r],a=function(e){e="?"==e?"unknown":"number"==e||"string"==e||"bool"==e?e:/^fn\(/.test(e)?"fn":/^\[/.test(e)?"array":"object";return d+"completion "+d+"completion-"+e}(s.type);t.guess&&(a+=" "+d+"guess"),n.push({text:s.name+o,displayText:s.displayName||s.name,className:a,data:s})}var e={from:e,to:i,list:n},c=null;g.on(e,"close",function(){w(c)}),g.on(e,"update",function(){w(c)}),g.on(e,"select",function(e,t){w(c);e=l.options.completionTip?l.options.completionTip(e.data):e.data.doc;e&&(c=x(t.parentNode.getBoundingClientRect().right+window.pageXOffset,t.getBoundingClientRect().top+window.pageYOffset,e,u,d+"hint-doc"))}),f(e)})},this.getHint.async=!0},g.TernServer.prototype={addDoc:function(e,t){var n={doc:t,name:e,changed:null};return this.server.addFile(e,k(this,n)),g.on(t,"change",this.trackChange),this.docs[e]=n},delDoc:function(e){e=t(this,e);e&&(g.off(e.doc,"change",this.trackChange),delete this.docs[e.name],this.server.delFile(e.name))},hideDoc:function(e){T(this);e=t(this,e);e&&e.changed&&c(this,e)},complete:function(e){e.showHint({hint:this.getHint})},showType:function(e,t,n){o(this,e,t,"type",n)},showDocs:function(e,t,n){o(this,e,t,"documentation",n)},updateArgHints:function(e){var n=this,o=e;if(T(n),!o.somethingSelected()){e=o.getTokenAt(o.getCursor()).state,e=g.innerMode(o.getMode(),e);if("javascript"==e.mode.name){var t=e.state.lexical;if("call"==t.info){for(var i,r,s=t.pos||0,a=o.getOption("tabSize"),c=o.getCursor().line,l=Math.max(0,c-9),u=!1;l<=c;--c){for(var f=o.getLine(c),d=0,p=0;;){var h=f.indexOf("\t",p);if(-1==h)break;d+=a-(h+d)%a-1,p=h+1}if(i=t.column-d,"("==f.charAt(i)){u=!0;break}}if(u)r=m(c,i),(e=n.cachedArgHints)&&e.doc==o.getDoc()&&0==y(r,e.start)?v(n,o,s):n.request(o,{type:"type",preferFunction:!0,end:r},function(e,t){!e&&t.type&&/^fn\(/.test(t.type)&&(n.cachedArgHints={start:r,type:function(i){var e=[],r=3;if(")"!=i.charAt(r))for(;;){var t=i.slice(r).match(/^([^, \(\[\{]+): /);if(t&&(r+=t[0].length,t=t[1]),e.push({name:t,type:function(e){for(var t=0,n=r;;){var o=i.charAt(r);if(e.test(o)&&!t)return i.slice(n,r);/[{\[\(]/.test(o)?++t:/[}\]\)]/.test(o)&&--t,++r}}(/[\),]/)}),")"==i.charAt(r))break;r+=2}var n=i.slice(r).match(/^\) -> (.*)$/);return{args:e,rettype:n&&n[1]}}(t.type),name:t.exprName||t.name||"fn",guess:t.guess,doc:o.getDoc()},v(n,o,s))})}}}},jumpToDef:function(e){function t(e){var e={type:"definition",variable:e||null},n=u(o,i.getDoc());o.server.request(f(o,n,e),function(e,t){if(e)return b(o,i,e);if(!t.file&&t.url)window.open(t.url);else{if(t.file){e=o.docs[t.file];if(e&&(t=function(e,t){for(var n=t.context.slice(0,t.contextOffset).split("\n"),o=t.start.line-(n.length-1),i=m(o,(1==n.length?t.start.ch:e.getLine(o).length)-n[0].length),r=e.getLine(o).slice(i.ch),s=1+o;s<e.lineCount()&&r.length<t.context.length;++s)r+="\n"+e.getLine(s);if(r.slice(0,t.context.length)==t.context)return t;var a,c=e.getSearchCursor(t.context,0,!1),l=1/0;for(;c.findNext();){var u=c.from(),f=1e4*Math.abs(u.line-i.line);(f=f||Math.abs(u.ch-i.ch))<l&&(a=u,l=f)}if(!a)return null;1==n.length?a.ch+=n[0].length:a=m(a.line+(n.length-1),n[n.length-1].length);o=t.start.line==t.end.line?m(a.line,a.ch+(t.end.ch-t.start.ch)):m(a.line+(t.end.line-t.start.line),t.end.ch);return{start:a,end:o}}(e.doc,t)))return o.jumpStack.push({file:n.name,start:i.getCursor("from"),end:i.getCursor("to")}),void r(o,n,e,t.start,t.end)}b(o,i,"Could not find a definition.")}})}var o,i;o=this,!function(e){var t=e.getCursor("end"),n=e.getTokenAt(t);return!(n.start<t.ch&&"comment"==n.type)&&/[\w)\]]/.test(e.getLine(t.line).slice(Math.max(t.ch-1,0),t.ch+1))}(i=e)?n(i,"Jump to variable",function(e){e&&t(e)}):t()},jumpBack:function(e){var t,n,o;e=e,n=(t=this).jumpStack.pop(),(o=n&&t.docs[n.file])&&r(t,u(t,e.getDoc()),o,n.start,n.end)},rename:function(e){var f=this,d=e,e=d.getTokenAt(d.getCursor());/\w/.test(e.string)?n(d,"New name for "+e.string,function(e){f.request(d,{type:"rename",newName:e,fullDocs:!0},function(e,t){if(e)return b(f,d,e);for(var n,o=f,i=t.changes,r=Object.create(null),s=0;s<i.length;++s){var a=i[s];(r[a.file]||(r[a.file]=[])).push(a)}for(n in r){var c=o.docs[n],l=r[n];if(c){l.sort(function(e,t){return y(t.start,e.start)});for(var u="*rename"+ ++p,s=0;s<l.length;++s){a=l[s];c.doc.replaceRange(a.text,a.start,a.end,u)}}}})}):b(f,d,"Not at a variable")},selectName:function(e){var a,c,l;l=u(a=this,(c=e).doc).name,a.request(c,{type:"refs"},function(e,t){if(e)return b(a,c,e);for(var n=[],o=0,i=c.getCursor(),r=0;r<t.refs.length;r++){var s=t.refs[r];s.file==l&&(n.push({anchor:s.start,head:s.end}),0<=y(i,s.start)&&y(i,s.end)<=0&&(o=n.length-1))}c.setSelections(n,o)})},request:function(e,n,o,t){var i=this,r=u(this,e.getDoc()),s=f(this,r,n,t),a=s.query&&this.options.queryOptions&&this.options.queryOptions[s.query.type];if(a)for(var c in a)s.query[c]=a[c];this.server.request(s,function(e,t){!e&&i.options.responseFilter&&(t=i.options.responseFilter(r,n,s,e,t)),o(e,t)})},destroy:function(){T(this),this.worker&&(this.worker.terminate(),this.worker=null)}};var m=g.Pos,d="CodeMirror-Tern-",l=250;function a(e,t,n){var o=e.docs[t];o?n(k(e,o)):e.options.getFile?e.options.getFile(t,n):n(null)}function u(e,t,n){for(var o in e.docs){var i=e.docs[o];if(i.doc==t)return i}if(!n)for(var r=0;;++r)if(!e.docs[o="[doc"+(r||"")+"]"]){n=o;break}return e.addDoc(n,t)}function t(e,t){return"string"==typeof t?e.docs[t]:(t=t instanceof g?t.getDoc():t)instanceof g.Doc?u(e,t):void 0}function c(e,t){e.server.request({files:[{type:"full",name:t.name,text:k(e,t)}]},function(e){e?window.console.error(e):t.changed=null})}function o(o,i,e,t,r){o.request(i,t,function(e,t){if(e)return b(o,i,e);var n;o.options.typeTip?n=o.options.typeTip(t):(n=h("span",null,h("strong",null,t.type||"not found")),t.doc&&n.appendChild(document.createTextNode(" — "+t.doc)),t.url&&(n.appendChild(document.createTextNode(" ")),(e=n.appendChild(h("a",null,"[docs]"))).href=t.url,e.target="_blank")),s(i,n,o),r&&r()},e)}function v(e,t,n){T(e);for(var o=e.cachedArgHints,i=o.type,r=h("span",o.guess?d+"fhint-guess":null,h("span",d+"fname",o.name),"("),s=0;s<i.args.length;++s){s&&r.appendChild(document.createTextNode(", "));var a=i.args[s];r.appendChild(h("span",d+"farg"+(s==n?" "+d+"farg-current":""),a.name||"?")),"?"!=a.type&&(r.appendChild(document.createTextNode(": ")),r.appendChild(h("span",d+"type",a.type)))}r.appendChild(document.createTextNode(i.rettype?") -> ":")")),i.rettype&&r.appendChild(h("span",d+"type",i.rettype));var o=t.cursorCoords(null,"page"),c=e.activeArgHints=x(o.right+1,o.bottom,r,t);setTimeout(function(){c.clear=C(t,function(){e.activeArgHints==c&&T(e)})},20)}function r(e,t,n,o,i){n.doc.setSelection(o,i),t!=n&&e.options.switchToDoc&&(T(e),e.options.switchToDoc(n.name,n.doc))}var p=0;function f(e,t,n,o){var i,r=[],s=0,a=!n.fullDocs,o=(a||delete n.fullDocs,(n="string"==typeof n?{type:n}:n).lineCharPositions=!0,null==n.end&&(n.end=o||t.doc.getCursor("end"),t.doc.somethingSelected()&&(n.start=t.doc.getCursor("start"))),n.start||n.end);for(i in t.changed?t.doc.lineCount()>l&&!1!=a&&t.changed.to-t.changed.from<100&&t.changed.from<=o.line&&t.changed.to>n.end.line?(r.push(function(e,t,n){for(var o,i=e.doc,r=null,s=null,a=t.line-1,c=Math.max(0,a-50);c<=a;--a){var l=i.getLine(a);l.search(/\bfunction\b/)<0||(f=g.countColumn(l,null,4),null!=r&&r<=f||(r=f,s=a))}null==s&&(s=c);var u=Math.min(i.lastLine(),n.line+20);if(null==r||r==g.countColumn(i.getLine(t.line),null,4))o=u;else for(o=n.line+1;o<u;++o){var f;if((f=g.countColumn(i.getLine(o),null,4))<=r)break}t=m(s,0);return{type:"part",name:e.name,offsetLines:t.line,text:i.getRange(t,m(o,n.line==o?null:0))}}(t,o,n.end)),n.file="#0",s=r[0].offsetLines,null!=n.start&&(n.start=m(n.start.line- -s,n.start.ch)),n.end=m(n.end.line-s,n.end.ch)):(r.push({type:"full",name:t.name,text:k(e,t)}),n.file=t.name,t.changed=null):n.file=t.name,e.docs){var c=e.docs[i];c.changed&&c!=t&&(r.push({type:"full",name:c.name,text:k(e,c)}),c.changed=null)}return{query:n,files:r}}var y=g.cmpPos;function h(e,t){var n=document.createElement(e);t&&(n.className=t);for(var o=2;o<arguments.length;++o){var i=arguments[o];"string"==typeof i&&(i=document.createTextNode(i)),n.appendChild(i)}return n}function n(e,t,n){var o,i;e.openDialog?((o=document.createDocumentFragment()).appendChild(document.createTextNode(t+": ")),(i=document.createElement("input")).type="text",o.appendChild(i),e.openDialog(o,n)):n(prompt(t,""))}function s(t,e,n){t.state.ternTooltip&&w(t.state.ternTooltip);var o=t.cursorCoords(),i=t.state.ternTooltip=x(o.right+1,o.bottom,e,t);function r(){var e;t.state.ternTooltip=null,i.parentNode&&((e=i).style.opacity="0",setTimeout(function(){w(e)},1100)),c()}var s=!1,a=!1,c=(g.on(i,"mousemove",function(){s=!0}),g.on(i,"mouseout",function(e){e=e.relatedTarget||e.toElement;e&&g.contains(i,e)||(a?r():s=!1)}),setTimeout(function(){a=!0,s||r()},n.options.hintDelay||1700),C(t,r))}function C(e,t){return e.on("cursorActivity",t),e.on("blur",t),e.on("scroll",t),e.on("setDoc",t),function(){e.off("cursorActivity",t),e.off("blur",t),e.off("scroll",t),e.off("setDoc",t)}}function x(e,t,n,o,i){i=h("div",d+"tooltip "+(i||""),n);i.style.left=e+"px",i.style.top=t+"px";(((o.options||{}).hintOptions||{}).container||document.body).appendChild(i);var n=o.cursorCoords(),t=window.innerWidth,o=window.innerHeight,r=i.getBoundingClientRect(),s=document.querySelector(".CodeMirror-hints"),a=r.bottom-o,c=r.right-t;return s&&0<c&&(i.style.left=0,r=i.getBoundingClientRect(),i.style.left=(e=e-s.offsetWidth-r.width)+"px",c=r.right-t),0<a&&(s=r.bottom-r.top,0<n.top-(n.bottom-r.top)-s?i.style.top=n.top-s+"px":o<s&&(i.style.height=o-5+"px",i.style.top=n.bottom-r.top+"px")),0<c&&(r.right-r.left>t&&(i.style.width=t-5+"px",c-=r.right-r.left-t),i.style.left=e-c+"px"),i}function w(e){var t=e&&e.parentNode;t&&t.removeChild(e)}function b(e,t,n){e.options.showError?e.options.showError(t,n):s(t,String(n),e)}function T(e){e.activeArgHints&&(e.activeArgHints.clear&&e.activeArgHints.clear(),w(e.activeArgHints),e.activeArgHints=null)}function k(e,t){var n=t.doc.getValue();return n=e.options.fileFilter?e.options.fileFilter(n,t.name,t.doc):n}function i(t){var n=t.worker=new Worker(t.options.workerScript),o=(n.postMessage({type:"init",defs:t.options.defs,plugins:t.options.plugins,scripts:t.options.workerDeps}),0),i={};function r(e,t){t&&(e.id=++o,i[o]=t),n.postMessage(e)}n.onmessage=function(e){var n=e.data;"getFile"==n.type?a(t,n.name,function(e,t){r({type:"getFile",err:String(e),text:t,id:n.id})}):"debug"==n.type?window.console.log(n.message):n.id&&i[n.id]&&(i[n.id](n.err,n.body),delete i[n.id])},n.onerror=function(e){for(var t in i)i[t](e);i={}},this.addFile=function(e,t){r({type:"add",name:e,text:t})},this.delFile=function(e){r({type:"del",name:e})},this.request=function(e,t){r({type:"req",body:e},t)}}});